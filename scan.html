<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Scan</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
</head>
<body>

<h1>QRを読み取る</h1>

<button id="startBtn" style="
  padding: 14px 24px;
  font-size: 18px;
">
  スキャン開始
</button>

<div id="reader" style="margin-top:20px;"></div>

<script type="module">
  import { auth } from "./firebase.js";
  import { exchange } from "./app.js";

  let myUid;
  let qr;
  let scanning = false;

  auth.onAuthStateChanged(user => {
    if (user) {
      myUid = user.uid;
    }
  });

  document.getElementById("startBtn").addEventListener("click", async () => {
    if (!myUid) {
      alert("ログイン中です。もう一度押してください");
      return;
    }

    qr = new Html5Qrcode("reader");

    await qr.start(
      { facingMode: "environment" },
      { fps: 10, qrbox: 250 },
      async (decodedText) => {
        if (scanning) return;
        if (decodedText === myUid) {
          alert("自分のQRは読み取れません");
          return;
        }

        scanning = true;
        await exchange(myUid, decodedText);
        await qr.stop();

        alert("交換成立！");
        location.href = "index.html";
      }
    );
  });
</script>

</body>
</html>

<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>QRを読み取る</title>

  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- QRスキャナライブラリ -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      text-align: center;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 {
      margin-bottom: 10px;
    }
    #startBtn {
      padding: 14px 26px;
      font-size: 18px;
      border-radius: 10px;
      border: none;
      background: #1b1b1b;
      color: #fff;
    }
    #reader {
      margin-top: 20px;
    }
    .note {
      margin-top: 16px;
      font-size: 14px;
      color: #555;
      line-height: 1.4;
    }
  </style>
</head>

<body>

<h1>QRを読み取る</h1>

<p>相手の「マイQRコード」を読み取ってください</p>

<button id="startBtn">スキャン開始</button>

<div id="reader"></div>

<p class="note">
  ※ スマホ標準カメラではなく<br>
  この画面の「スキャン開始」を押してください
</p>

<script type="module">
  import { auth } from "./firebase.js";
  import { exchange } from "./app.js";

  let myUid = null;
  let qr = null;
  let scanning = false;

  // Firebase 認証完了を待つ
  auth.onAuthStateChanged(user => {
    if (user) {
      myUid = user.uid;
      console.log("ログインUID:", myUid);
    }
  });

  // ユーザー操作でカメラ起動（iOS / Android 対応）
  document.getElementById("startBtn").addEventListener("click", async () => {
    if (!myUid) {
      alert("ログイン中です。もう一度押してください。");
      return;
    }

    if (qr) return;

    qr = new Html5Qrcode("reader");

    try {
      await qr.start(
        { facingMode: "environment" },
        {
          fps: 10,
          qrbox: { width: 300, height: 300 }
        },
        async (decodedText) => {
          if (scanning) return;

          console.log("QR読み取り成功:", decodedText);

          if (decodedText === myUid) {
            alert("自分のQRは読み取れません");
            return;
          }

          scanning = true;

          try {
            await exchange(myUid, decodedText);
            alert("交換成立！");
            await qr.stop();
            location.href = "index.html";
          } catch (e) {
            alert(e.message);
            scanning = false;
          }
        }
      );
    } catch (e) {
      console.error("カメラ起動失敗:", e);
      alert("カメラを起動できませんでした。権限を確認してください。");
    }
  });
</script>

</body>
</html>
